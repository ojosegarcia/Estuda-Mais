<!-- 
  Este 'ng-container' √© a corre√ß√£o principal.
  1. Ele "ouve" o Observable 'currentUser$'
  2. O 'async' pipe se inscreve e espera os dados.
  3. Quando os dados chegam, ele os coloca na vari√°vel local 'currentUser'.
  4. O *ngIf s√≥ renderiza o conte√∫do quando 'currentUser' n√£o √© nulo.
-->
<ng-container *ngIf="currentUser$ | async as currentUser; else loading">

  <div class="perfil-container">
    <div class="perfil-header">
      <div class="profile-avatar-large">
        <!-- Passamos 'currentUser.nomeCompleto' para a fun√ß√£o -->
        <span class="avatar-initials-large">{{ getUserInitials(currentUser.nomeCompleto) }}</span>
      </div>
      <h1 class="perfil-title">Meu Perfil</h1>
    </div>

    <!-- 
      Agora todo o HTML abaixo tem acesso seguro √† vari√°vel 'currentUser'
    -->
    <div class="perfil-content">
      <div class="info-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="icon">üë§</span>
            Informa√ß√µes Pessoais
          </h2>
        </div>

        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <label class="info-label">Nome Completo</label>
              <p class="info-value">{{ currentUser.nomeCompleto }}</p>
            </div>

            <div class="info-item">
              <label class="info-label">Email</label>
              <p class="info-value">{{ currentUser.email }}</p>
            </div>

            <div class="info-item">
              <label class="info-label">Tipo de Usu√°rio</label>
              <div class="badge-container">
                <span class="user-type-badge" [class.professor]="isProfessor(currentUser)">
                  {{ currentUser.tipoUsuario }}
                </span>
              </div>
            </div>

            <!-- INFO ALUNO: Passamos 'currentUser' para as fun√ß√µes helper -->
            <div class="info-item" *ngIf="isAluno(currentUser) && asAluno(currentUser).escolaridade">
              <label class="info-label">Escolaridade</label>
              <p class="info-value">{{ asAluno(currentUser).escolaridade }}</p>
            </div>

            <div class="info-item" *ngIf="isAluno(currentUser) && asAluno(currentUser).interesse">
              <label class="info-label">Meu Objetivo</label>
              <p class="info-value">{{ getInteresseLabel(asAluno(currentUser).interesse) }}</p>
            </div>
          </div>

          <!-- INFO PROFESSOR: Passamos 'currentUser' para as fun√ß√µes helper -->
          <div class="info-item full-width" *ngIf="isProfessor(currentUser) && asProfessor(currentUser).sobre">
            <label class="info-label">Sobre</label>
            <p class="info-value about-text">{{ asProfessor(currentUser).sobre }}</p>
          </div>

          <!-- MAT√âRIAS DO PROFESSOR -->
          <div class="info-item full-width" *ngIf="isProfessor(currentUser) && asProfessor(currentUser).materias && asProfessor(currentUser).materias!.length > 0">
            <label class="info-label">
              <span class="icon">üìö</span>
              Mat√©rias que Leciono
            </label>
            <div class="materias-badges">
              <span class="materia-badge" *ngFor="let materia of asProfessor(currentUser).materias!">
                <span class="materia-icon">{{ materia.icone || '‚Ä¢' }}</span>
                {{ materia.nome }}
              </span>
            </div>
          </div>

          <!-- AVISO DE SEM MAT√âRIAS -->
          <div class="info-item full-width" *ngIf="isProfessor(currentUser) && (!asProfessor(currentUser).materias || asProfessor(currentUser).materias!.length === 0)">
            <label class="info-label">
              <span class="icon">‚ö†Ô∏è</span>
              Mat√©rias que Leciono
            </label>
            <p class="info-value warning-text">Nenhuma mat√©ria cadastrada. Edite seu perfil para adicionar.</p>
          </div>
        </div>
      </div>

      <!-- STATS CARD -->
      <div class="stats-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="icon">üìä</span>
            Estat√≠sticas
          </h2>
        </div>
        <div class="card-body">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-icon">üìö</div>
              <div class="stat-content">
                <p class="stat-value">0</p>
                <p class="stat-label">Aulas {{ isProfessor(currentUser) ? 'Ministradas' : 'Realizadas' }}</p>
              </div>
            </div>
            <!-- ... outros stats ... -->
          </div>
        </div>
      </div>

      <!-- ACTIONS CARD (Seu bot√£o 'editarPerfil()' j√° est√° correto) -->
      <div class="actions-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="icon">‚öôÔ∏è</span>
            A√ß√µes
          </h2>
        </div>
        <div class="card-body">
          <button class="btn-action" (click)="editarPerfil()">
            <span class="action-icon">‚úèÔ∏è</span>
            <span>Editar Perfil</span>
          </button>
          <!-- ... outros bot√µes desabilitados ... -->
        </div>
      </div>
    </div>

  </div>
</ng-container>

<!-- 
  Este √© o 'else' do *ngIf. 
  Ele usa o seu CSS de 'loading-state' que j√° estava no HTML.
-->
<ng-template #loading>
  <div class="loading-state">
    <div class="loading-spinner"></div>
    <p>Carregando perfil...</p>
  </div>
</ng-template>